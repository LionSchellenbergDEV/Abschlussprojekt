@page "/mail-details"
@using MailKit
@using MailKit.Net.Imap
@using MailKit.Security
@using MimeKit
@using System.Threading.Tasks
@inject NavigationManager Navigation
@inject MailCacheService MailCache
@rendermode InteractiveServer


<link href="css/layout.css" rel="stylesheet" />
<link href="css/components.css" rel="stylesheet" />
<link href="css/table.css" rel="stylesheet" />

<PageTitle>E-Mail Details</PageTitle>
<div id="mobile-nav">
<img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT198aTj6RHKUOtk8zEMheM6QU-1pdx6Ugeth&s" alt="Datatronic Logo">
    <ul>
        <li class="active" data-target="email-section">
            <a href="/" class="nav-link">📧 E-Mail Tickets</a>
        </li>
        <li data-target="ticket-section">
            <a href="/sagetickets" class="nav-link">🎫 Sage Tickets</a>
        </li>
    </ul>
    <button>
        <a href="/abmelden" class="logout-link">
                🚪 Abmelden
            </a>
    </button>
    </div>
<div class="dashboard-container">
    <aside class="sidebar">
        <div class="logo">
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT198aTj6RHKUOtk8zEMheM6QU-1pdx6Ugeth&s" alt="Datatronic Logo">
        </div>

        <nav class="main-nav">
            <ul>
                <li data-target="email-section">
                    <a href="/" class="nav-link active">📧 E-Mail Tickets</a>
                </li>
                <li data-target="ticket-section">
                    <a href="/sagetickets" class="nav-link">🎫 Sage Tickets</a>
                </li>
            </ul>
        </nav>

        <div class="logout-section">
            <a href="/abmelden" class="logout-link">
                🚪 Abmelden
            </a>
        </div>
    </aside>

    <main class="main-content">
        <header class="content-header">
            <h1 id="dashboard-title">E-Mail Details</h1>
        </header>

        <div class="card email-detail-card"> 

            @if (loading)
            {
                    <p><em>Lade E-Mail-Details...</em></p>
            }
            else if (message == null)
            {
                    <h4 style="color: red;">E-Mail konnte nicht geladen werden.</h4>
                    <p>@errorMessage</p>
            }
            
            else
            {
                <div class="action-bar">
                    <button class="btn btn-secondary" @onclick="GoBack">← Zurück zur Übersicht</button>
                    <button class="btn btn-primary" @onclick="AssignMailToMeAsync">✅ Sich zuweisen</button>
                </div>

                <hr style="margin-top: 15px; margin-bottom: 20px;">

                <div class="detail-header-flat"> 
                    <p class="detail-subject"><strong>@message.Subject</strong></p> 
                    <p class="detail-meta-item">Von: @message.From</p>
                    <p class="detail-meta-item">Datum: @message.Date.LocalDateTime.ToString("dd.MM.yyyy HH:mm")</p>
                </div>

                <hr style="margin-top: 20px; margin-bottom: 20px;">

                <div class="detail-body">
                @if (!string.IsNullOrEmpty(HtmlBody))
                {
                    @((MarkupString)HtmlBody)
                }
                else if (!string.IsNullOrEmpty(TextBody))
                {
                            <pre>@TextBody</pre>
                }
                else
                {
                            <p>Kein lesbarer Inhalt gefunden.</p>
                }
                </div>
            }
        </div>
    </main>
</div>
<style>
    .btn-secondary {
    background-color: #f0f0f0; 
    color: #333;
}
.btn {
    padding: 10px 15px;
    border: none;
    cursor: pointer;
    border-radius: 5px;
    font-weight: bold;
    transition: background-color 0.2s;
}

.btn-primary {
    background-color: #007bff; 
    color: white;
}
   .detail-header-flat {
    padding: 0;
    margin: 0;
}

.detail-header-flat p {
    margin: 3px 0; 
    padding: 0;
    text-align: left; 
}


.detail-subject {
    font-weight: bold;
    color: #333;
}


.detail-meta-item {
    font-size: 0.95em;
    color: #555;
    font-weight: normal;
}


.action-bar {
    display: flex;
    justify-content: space-between;
    padding-bottom: 10px;
}
</style>

@code {
    /// <summary>
    /// Die IMAP Unique ID (Uid) der anzuzeigenden Nachricht, übergeben als Query-Parameter.
    /// </summary>
    [Parameter]
    [SupplyParameterFromQuery]
    public int Uid { get; set; }

    [Parameter]
    [SupplyParameterFromQuery]
    public string? Folder { get; set; } = "INBOX";

    private MimeMessage? message;
    private bool loading = true;
    private string? errorMessage;
    private string? HtmlBody;
    private string? TextBody;

    // IMAP-Verbindungsparameter
    private const string ImapUsername = "";
    private const string ImapPassword = "";
    private const string ImapHost = "";
    private const int ImapPort = 993;
    private const string AssignedFolderName = "Assigned";

    /// <summary>
    /// Wird beim Initialisieren der Komponente ausgeführt. Versucht, die E-Mail aus dem Cache zu laden,
    /// andernfalls wird sie vom IMAP-Server abgerufen.
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        loading = true;

        // Prüfen, ob die Nachricht im Cache ist
        message = MailCache.GetCachedMessage(Uid);

        if (message == null)
        {
            await FetchMessageDetailsAsync();
        }

        if (message != null)
        {
            HtmlBody = message.HtmlBody;
            TextBody = message.TextBody;
        }

        loading = false;
    }

    /// <summary>
    /// Stellt eine Verbindung zum IMAP-Server her, ruft die vollständige MimeMessage mittels UniqueId ab
    /// und speichert sie im In-Memory-Cache.
    /// </summary>
    private async Task FetchMessageDetailsAsync()
    {
        errorMessage = null;
        string targetFolder = string.IsNullOrEmpty(Folder) ? "INBOX" : Folder;
        try
        {
            using var client = new ImapClient();
            await client.ConnectAsync(ImapHost, ImapPort, SecureSocketOptions.SslOnConnect);
            await client.AuthenticateAsync(ImapUsername, ImapPassword);

            var folder = await client.GetFolderAsync(targetFolder);
            await folder.OpenAsync(FolderAccess.ReadOnly);

            var messageUid = new UniqueId((uint)Uid);
            message = await folder.GetMessageAsync(messageUid);

            // Cache aktualisieren
            MailCache.CacheMessage(Uid, message);

            await client.DisconnectAsync(true);
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
    }

    /// <summary>
    /// Kopiert die aktuelle E-Mail vom Posteingang in den 'Assigned'-Ordner des IMAP-Kontos.
    /// </summary>
    private async Task AssignMailToMeAsync()
    {
        if (message == null) return;

        try
        {
            using var client = new ImapClient();
            await client.ConnectAsync(ImapHost, ImapPort, SecureSocketOptions.SslOnConnect);
            await client.AuthenticateAsync(ImapUsername, ImapPassword);

            var inbox = await client.GetFolderAsync("INBOX");
            await inbox.OpenAsync(FolderAccess.ReadOnly);

            var assignedFolder = await client.GetFolderAsync(AssignedFolderName);
            if (assignedFolder == null || !assignedFolder.Exists)
            {
                var root = client.GetFolder(client.PersonalNamespaces.FirstOrDefault()?.Path);
                assignedFolder = await root.CreateAsync(AssignedFolderName, true);
            }

            if (assignedFolder != null)
            {
                await inbox.CopyToAsync(new UniqueId((uint)Uid), assignedFolder);
            }

            await client.DisconnectAsync(true);

            // Cache leeren und zurück
            await JsRuntime.InvokeVoidAsync("localStorage.removeItem", "cachedEmails_assigned_page");  
            Navigation.NavigateTo("/");
        }
        catch (Exception ex)
        {
            errorMessage = $"Fehler beim Kopieren der E-Mail: {ex.Message}";
        }
    }
    /// <summary>
    /// Navigiert zurück zur E-Mail-Übersichtsseite.
    /// </summary>
    private void GoBack()
    {
        Navigation.NavigateTo("/");
    }
}